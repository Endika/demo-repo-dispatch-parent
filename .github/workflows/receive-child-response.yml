name: Parent - Receive Child Responses

on:
  repository_dispatch:
    types: [child-response]

jobs:
  comment-on-pr:
    runs-on: ubuntu-latest
    environment: CI
    if: github.event.client_payload.is_pr_command == 'true' && github.event.client_payload.pr_number != ''
    
    steps:
    - name: Display Child Response Info
      run: |
        echo "📨 Child Repository Response for PR Command!"
        echo "👶 Child Repository: ${{ github.event.client_payload.child_repository }}"
        echo "📋 PR Number: ${{ github.event.client_payload.pr_number }}"
        echo "📊 Response Status: ${{ github.event.client_payload.response_status }}"
        echo "💬 Response Message: ${{ github.event.client_payload.response_message }}"
        echo "🎯 Target Repo: ${{ github.event.client_payload.target_repo }}"
        
    - name: Comment Child Response on PR
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = '${{ github.event.client_payload.pr_number }}';
          const childRepo = '${{ github.event.client_payload.child_repository }}';
          const targetRepo = '${{ github.event.client_payload.target_repo }}';
          const command = '${{ github.event.client_payload.command }}' || 'demo-build';
          const responseStatus = '${{ github.event.client_payload.response_status }}';
          const responseMessage = '${{ github.event.client_payload.response_message }}';
          const childWorkflowUrl = '${{ github.event.client_payload.child_workflow_url }}';
          const commitSha = '${{ github.event.client_payload.commit_sha }}' || '';
          const commitUrl = '${{ github.event.client_payload.commit_url }}' || '';
          const artifactsUpdated = '${{ github.event.client_payload.artifacts_updated }}' === 'true';
          
          const statusEmoji = {
            'success': '✅',
            'failure': '❌',
            'synchronized': '🔄',
            'tested': '🧪',
            'processed': '⚙️'
          }[responseStatus] || '📊';
          
          let message = `## ${statusEmoji} Child Build Result: \`${targetRepo}\`\n\n`;
          message += `**Command:** \`/${command}\`\n`;
          message += `**Status:** ${responseStatus}\n`;
          message += `**Message:** ${responseMessage}\n\n`;
          
          // Agregar información de artifacts y commits
          if (artifactsUpdated && commitSha) {
            message += `**📝 New Commit:** [\`${commitSha.substring(0, 8)}\`](${commitUrl})\n`;
            message += `**🤖 Auto-Update:** Child repository updated with parent artifacts\n`;
          } else {
            message += `**📦 Artifacts:** No changes detected in child repository\n`;
          }
          
          message += `\n🔗 [View child workflow run](${childWorkflowUrl})\n`;
          message += `⏰ Completed at: ${new Date().toISOString()}`;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: parseInt(prNumber),
            body: message
          });

